<!--StartFragment-->

åœ¨æ™ºèƒ½åˆçº¦é¢†åŸŸï¼Œ"ä»¥å¤ªåŠè™šæ‹Ÿæœº EVM" ä»¥åŠå…¶ç®—æ³•å’Œæ•°æ®ç»“æ„å°±æ˜¯ç¬¬ä¸€æ€§åŸç†ã€‚\


æœ¬æ–‡ä»åˆçº¦ä¸ºä»€ä¹ˆè¦åˆ†ç±»å‡ºå‘ï¼Œç»“åˆæ¯ä¸ªåœºæ™¯å¯èƒ½é¢å¯¹æ€æ ·çš„æ¶æ„æ”»å‡»ï¼Œæœ€ç»ˆç»™å‡ºä¸€å¥—è¾¾æˆç›¸å¯¹å®‰å…¨çš„åˆçº¦åˆ†ç±»åˆ†æç®—æ³•ã€‚

**è™½ç„¶æŠ€æœ¯å«é‡è¾ƒé«˜ï¼Œä½†äº¦å¯ä½œä¸ºæ‚è°ˆè¯»ç‰©**ï¼Œä¸€è§ˆå»ä¸­å¿ƒåŒ–ç³»ç»Ÿé—´åšå¼ˆçš„é»‘æš—æ£®æ—ã€‚



* ***



## **1ã€åˆçº¦ä¸ºä»€ä¹ˆè¦åˆ†ç±»ï¼Ÿ**

å› ä¸ºå¤ªé‡è¦äº†ï¼Œå¯è°“æ˜¯äº¤æ˜“æ‰€ã€é’±åŒ…ã€åŒºå—é“¾æµè§ˆå™¨ã€æ•°æ®åˆ†æå¹³å°ç­‰ç­‰Dappçš„åŸºçŸ³ï¼

ä¸€ç¬”äº¤æ˜“ä¹‹æ‰€ä»¥æ˜¯ERC20è½¬è´¦ï¼Œæ˜¯å› ä¸ºä»–çš„è¡Œä¸ºç¬¦åˆERC20æ ‡å‡†ï¼Œè‡³å°‘å¾—æœ‰ï¼š

1. äº¤æ˜“çš„çŠ¶æ€æ˜¯æˆåŠŸ
2. Toåœ°å€ä¸ºæŸä¸ªç¬¦åˆERC20æ ‡å‡†çš„åˆçº¦
3. è°ƒç”¨äº†Transferå‡½æ•°ï¼Œå…¶ç‰¹ç‚¹æ˜¯è¯¥äº¤æ˜“CallDataçš„å‰4ä½ä¸º`0xa9059cbb`
4. æ‰§è¡Œåï¼Œåœ¨è¯¥Toåœ°å€ä¸Šå‘å‡ºäº†`transfer`çš„äº‹ä»¶

**åˆ†ç±»æœ‰è¯¯åˆ™äº¤æ˜“è¡Œä¸ºä¼šè¯¯åˆ¤**

ä»¥äº¤æ˜“è¡Œä¸ºä¸ºåŸºçŸ³ï¼Œåˆ™Toåœ°å€èƒ½å¦è¢«å‡†ç¡®åˆ†ç±»åˆ™å¯¹å…¶CallDataçš„åˆ¤æ–­ä¼šæœ‰æˆªç„¶ä¸ç„¶çš„ç»“è®ºã€‚å¯¹Dappè€Œè¨€ï¼Œé“¾ä¸Šé“¾ä¸‹çš„ä¿¡æ¯æ²Ÿé€šé«˜åº¦ä¾èµ–äºäº¤æ˜“äº‹ä»¶çš„ç›‘å¬ï¼Œè€ŒåŒæ ·çš„äº‹ä»¶ç¼–ç ä¹Ÿåªæœ‰åœ¨ç¬¦åˆæ ‡å‡†çš„åˆçº¦ä¸­å‘å‡ºï¼Œæ‰å…·æœ‰å¯ä¿¡åº¦ã€‚

**åˆ†ç±»æœ‰è¯¯åˆ™äº¤æ˜“ä¼šè¯¯å…¥é»‘æ´**

å¦‚æœç”¨æˆ·è¿›è¡Œä¸€ç¬”Tokenè½¬ç§»ï¼Œè½¬å…¥åˆ°æŸä¸ªåˆçº¦ä¸­ï¼Œå¦‚æœè¯¥åˆçº¦æ²¡æœ‰é¢„è®¾Tokenè½¬å‡ºçš„å‡½æ•°æ–¹æ³•ï¼Œåˆ™èµ„é‡‘ä¼šé›·åŒäºBurnä¸€æ ·è¢«é”å®šï¼Œæ— æ³•æ§åˆ¶

ä¸”å¦‚ä»Šå¤§é‡é¡¹ç›®å¼€å§‹å¢åŠ å†…ç½®çš„é’±åŒ…æ”¯æŒï¼Œè¦ä¸ºç”¨æˆ·ç®¡ç†é’±åŒ…ä¹Ÿå°±ä¸å¯é¿å…çš„ï¼Œéœ€è¦æ—¶åˆ»ä»é“¾ä¸Šå®æ—¶åˆ†ç±»å‡ºæœ€æ–°éƒ¨ç½²çš„åˆçº¦ï¼Œæ˜¯å¦èƒ½å¤Ÿå»åˆèµ„äº§æ ‡å‡†ã€‚

æ‹“å±•é˜…è¯»ç¬¬1æ®µï¼š[ã€åˆçº¦è§£è¯»ã€‘CryptoPunk ä¸–ç•Œä¸Šæœ€æ—©çš„å»ä¸­å¿ƒåŒ–NFTäº¤æ˜“å¸‚åœº](http://mp.weixin.qq.com/s?\__biz=MzIyMTQ5MTg5Mw==\&mid=2247483924\&idx=1\&sn=30a642fa1acec069e31b40937e2d7de4\&chksm=e83aa5cedf4d2cd861d3cf09c555720d7e6b89febb909ee88853d88f86ca913d3a1d701c1c00\&scene=21#wechat_redirect)


![640.png](https://img.learnblockchain.cn/attachments/2023/06/S8HWwgR0648713022fdb5.png)


## **2ã€åˆ†ç±»ä¼šæœ‰æ€æ ·çš„é£é™©ï¼Ÿ**

**é“¾ä¸Šæ˜¯ä¸€ä¸ªæ²¡æœ‰èº«ä»½æ²¡æœ‰æ³•æ²»çš„åœ°æ–¹ï¼Œä½ æ— æ³•åˆ¶æ­¢ä¸€ç¬”æ­£å¸¸çš„äº¤æ˜“ï¼Œå“ªæ€•ä»–æ˜¯æ¶æ„çš„ã€‚**

ä»–å¯ä»¥æ˜¯å†’å……å¤–å©†çš„ç‹¼ï¼Œåšå‡ºå¤šæ•°ç¬¦åˆä½ é¢„æœŸçš„å¤–å©†è¡Œä¸ºï¼Œä½†ç›®çš„æ˜¯è¿›å±‹æŠ¢åŠ«ã€‚

**å£°æ˜æ ‡å‡†ï¼Œä½†å¯èƒ½å®è´¨ä¸ç¬¦åˆ**

å¸¸è§çš„åˆ†ç±»æ–¹å¼æ˜¯ç›´æ¥é‡‡ç”¨EIP-165æ ‡å‡†ï¼Œè¯»å–è¯¥åœ°å€æ˜¯å¦æ”¯æŒERC20ç­‰ï¼Œå½“ç„¶ï¼Œè¿™æ˜¯ä¸€ä¸ªé«˜æ•ˆç‡çš„æ–¹æ³•ï¼Œä½†æ˜¯æ¯•ç«Ÿåˆçº¦æ˜¯å¯¹æ–¹æ§åˆ¶ï¼Œæ‰€ä»¥ç»ˆç©¶æ˜¯å¯ä»¥ä¼ªé€ å‡ºä¸€ä»½ç”³æ˜ã€‚

165æ ‡å‡†çš„æŸ¥è¯¢ï¼Œåªæ˜¯åœ¨é“¾ä¸Šæœ‰é™çš„æ“ä½œç ä¸­ï¼Œç”¨æœ€ä½æˆæœ¬å»é˜²æ­¢èµ„é‡‘è½¬å…¥é»‘æ´çš„æ–¹æ³•ã€‚

è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¹‹å‰åˆ†æNFTçš„æ—¶å€™ï¼Œç‰¹åœ°æåŠæ ‡å‡†ä¸­ä¼šæœ‰ä¸€ç±»`SafeTransferFrom`çš„æ–¹æ³•ï¼Œå…¶ä¸­`Safe`å°±æ˜¯æŒ‡ä»£äº†é‡‡ç”¨165æ ‡å‡†åˆ¤æ–­å‡ºå¯¹æ–¹å£°æ˜è‡ªå·±å…·å¤‡äº†NFTçš„è½¬ç§»èƒ½åŠ›ã€‚

æ‹“å±•é˜…è¯» ç¬¬2.2æ®µï¼š[ã€æºç è§£è¯»ã€‘ä½ ä¹°çš„NFTåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ](http://mp.weixin.qq.com/s?\__biz=MzIyMTQ5MTg5Mw==\&mid=2247483815\&idx=1\&sn=5f91df631b450944739419be185e597c\&chksm=e83aa67ddf4d2f6bf24b9f6139bd685db9b5f3ff5a131f84c179a5166ad42337f0b2aabe0bf0\&scene=21#wechat_redirect)

å”¯æœ‰ä»åˆçº¦å­—èŠ‚ç å‡ºå‘ï¼Œåšæºç å±‚é¢çš„é™æ€åˆ†æï¼Œä»åˆçº¦é¢„æœŸçš„è¡Œä¸ºå‡ºå‘æ‰æœ‰æ›´ç²¾å‡†çš„å¯èƒ½æ€§ã€‚

## **3ã€åˆçº¦åˆ†ç±»æ–¹æ¡ˆè®¾è®¡**

æ¥ä¸‹æ¥å’±ä»¬å°†ç³»ç»Ÿçš„åˆ†ææ•´ä½“æ–¹æ¡ˆï¼Œæ³¨æ„æˆ‘ä»¬çš„**ç›®çš„æ˜¯â€œç²¾åº¦â€å’Œâ€œæ•ˆç‡â€ä¸¤é¡¹æ ¸å¿ƒæŒ‡æ ‡**ã€‚

è¦çŸ¥é“å³ä½¿æ–¹å‘æ˜¯å¯¹çš„ï¼Œä½†è¦æŠµè¾¾å¤§æ´‹çš„å½¼å²¸è·¯é€”ä¹Ÿå¹¶ä¸æ˜æœ—ï¼Œè¦åšå­—èŠ‚ç åˆ†æçš„ç¬¬ä¸€ç«™æ˜¯è·å–ä»£ç 

### **3.1ã€å¦‚ä½•è·å–åˆ°ä»£ç ï¼Ÿ**

ä»ä¸Šé“¾åçš„è§’åº¦è®²æœ‰`getCode`ï¼Œä¸€ä¸ªRPCæ–¹æ³•ï¼Œå¯ä»¥ä»é“¾ä¸ŠæŒ‡å®šçš„åœ°å€é‡Œè·å–åˆ°å­—èŠ‚ç ï¼Œå•è®ºè¯»å–çš„è¯è¿™æ˜¯éå¸¸å¿«æ·çš„ï¼Œå› ä¸ºä»EVMçš„è´¦å·ç»“æ„ä¸­å°±æŠŠcodeHashæ”¾åœ¨æœ€é¡¶ç«¯çš„ä½ç½®ã€‚


![6401.png](https://img.learnblockchain.cn/attachments/2023/06/iEbgipud64871399978d2.png)

ä½†æ˜¯è¿™ä¸ªæ–¹æ³•ç­‰äºæ˜¯å•ç‹¬å¯¹æŸä¸ªåœ°å€åšè·å–ï¼Œæƒ³è¦è¿›ä¸€æ­¥æå‡ç²¾åº¦å’Œæ•ˆç‡å‘¢ï¼Ÿ

å¦‚æœæ˜¯éƒ¨ç½²åˆçº¦çš„äº¤æ˜“ï¼Œå¦‚ä½•åœ¨å…¶åˆšæ‰§è¡Œå®Œç”šè‡³ä»–è¿˜åœ¨å†…å­˜æ± ä¸­ä¾¿è·å–éƒ¨ç½²çš„ä»£ç ï¼Ÿ

å¦‚æœè¯¥ç¬”äº¤æ˜“æ˜¯åˆçº¦å·¥å‚çš„æ¨¡å¼ï¼Œåˆ™äº¤æ˜“çš„Calldataé‡Œæ˜¯å¦å­˜åœ¨æºç å‘¢ï¼Ÿ

æœ€åçš„æˆ‘çš„æ–¹å¼æ˜¯ï¼Œæ˜¯åˆ†ç±»è¿›è¡Œä¸€ç§ç±»ä¼¼ç­›å­çš„æ¨¡å¼

1. å¯¹äºéåˆçº¦éƒ¨ç½²çš„äº¤æ˜“ï¼Œåˆ™ç›´æ¥ç”¨`getCode`è·å–å…¶ä¸­æ¶‰åŠçš„åœ°å€è¿›è¡Œåˆ†ç±»ï¼Œ
2. å¯¹äºæœ€æ–°å†…å­˜æ± çš„äº¤æ˜“ï¼Œç­›é€‰å‡ºtoåœ°å€ä¸ºç©ºçš„äº¤æ˜“ï¼Œå…¶CallDataåˆ™æ˜¯å¸¦æœ‰æ„é€ å‡½æ•°çš„æºä»£ç 
3. å¯¹äºåˆçº¦å·¥å‚æ¨¡å¼çš„äº¤æ˜“ï¼Œç”±äºå…¶ä¸­å¯èƒ½æ˜¯åˆçº¦éƒ¨ç½²å‡ºçš„åˆçº¦å†å¾ªç¯è°ƒç”¨å…¶ä»–åˆçº¦æ¥æ‰§è¡Œéƒ¨ç½²ï¼Œåˆ™é€’å½’çš„å»åˆ†æè¯¥ç¬”äº¤æ˜“çš„å­äº¤æ˜“ï¼Œè®°å½•æ¯ä¸ªtype ä¸º`CREATE`æˆ–è€…ä¸º`CREATE2`çš„Callã€‚

æˆ‘åšäº†ä¸ªdemoå®ç°çš„æ—¶å€™ï¼Œå‘ç°è¿˜å¥½ç°åœ¨rpcçš„ç‰ˆæœ¬æ¯”è¾ƒé«˜ï¼Œå› ä¸ºæ•´ä¸ªè¿‡ç¨‹æœ€éš¾çš„ä¾¿æ˜¯æ‰§è¡Œ3çš„æ—¶å€™ï¼Œå¦‚ä½•é€’å½’æ‰¾åˆ°æŒ‡å®štypeçš„callï¼Œæœ€åº•å±‚çš„æ–¹å¼æ˜¯é€šè¿‡opcodeè¿˜åŸä¸Šä¸‹æ–‡ï¼Œæˆ‘åƒäº†ä¸€æƒŠï¼

è¿˜å¥½ç°åœ¨çš„gethç‰ˆæœ¬é‡Œæœ‰`debug_traceTransaction` æ–¹æ³•ï¼Œä»–å¯ä»¥å¸®åŠ©è§£å†³åœ¨é€šè¿‡opcodeæ“ä½œç ä¸­æ¢³ç†æ¯ä¸€ä¸ªcallçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæ•´ç†å‡ºæ ¸å¿ƒçš„å­—æ®µã€‚

æœ€ç»ˆå¯ä»¥å¯¹å¤šç§éƒ¨ç½²æ¨¡å¼çš„ï¼ˆç›´æ¥éƒ¨ç½²ï¼Œå·¥å‚æ¨¡å¼å•éƒ¨ç½²ï¼Œå·¥å‚æ¨¡å¼æ‰¹é‡éƒ¨ç½²ï¼‰çš„åŸå§‹å­—èŠ‚ç éƒ½è·å–åˆ°ã€‚

### **3.2ã€å¦‚ä½•ä»ä»£ç åˆ†ç±»ï¼Ÿ**

æœ€æœ€ç®€å•ä½†ä¸å®‰å…¨çš„æ–¹å¼ï¼Œæ˜¯æŠŠcodeç›´æ¥åšå­—ç¬¦ä¸²åŒ¹é…ï¼Œä»¥ERC20ä¸ºä¾‹ç¬¦åˆæ ‡å‡†çš„å‡½æ•°åˆ™æœ‰


![6402.png](https://img.learnblockchain.cn/attachments/2023/06/7mLHgKwE648713b95e28b.png)

åœ¨å‡½æ•°åä¹‹åçš„ï¼Œåˆ™æ˜¯è¯¥å‡½æ•°çš„å‡½æ•°ç­¾åï¼Œä¹‹å‰åœ¨åˆ†æçš„æ—¶å€™æåŠï¼Œäº¤æ˜“éƒ½æ˜¯ä¾èµ–åŒ¹é…callDataçš„å‰4ä½æ‰¾åˆ°ç›®æ ‡å‡½æ•°çš„ï¼Œæ‹“å±•é˜…è¯»ï¼š

æ‰€ä»¥åˆçº¦å­—èŠ‚ç é‡Œå¿…ç„¶å­˜å‚¨æœ‰è¿™6ä¸ªå‡½æ•°çš„ç­¾åã€‚

å½“ç„¶ï¼Œè¿™ç§æ–¹æ³•éå¸¸å¿«æ·6ä¸ªéƒ½æŸ¥åˆ°å°±å®Œäº‹çš„ï¼Œä½†ä¸å®‰å…¨çš„å› ç´ åˆ™æ˜¯ï¼Œå¦‚æœæˆ‘é‡‡ç”¨solidityåˆçº¦ä¸­ï¼Œå•ç‹¬è®¾è®¡ä¸€ä¸ªå˜é‡ï¼Œå­˜å‚¨å€¼ä¸º`0x18160ddd` é‚£ä¹ˆä»–ä¹Ÿä¼šå°†è®¤ä¸ºæˆ‘æœ‰äº†è¿™ä¸ªå‡½æ•°ã€‚

### **3.3ã€å‡†ç¡®ç‡æå‡1-åç¼–è¯‘**

é‚£è¿›ä¸€æ­¥çš„å‡†ç¡®æ–¹æ³•åˆ™æ˜¯åšOpcodeçš„åç¼–è¯‘ï¼åç¼–è¯‘åˆ™æ˜¯å°†è·å–åˆ°çš„å­—èŠ‚ç è½¬åˆ°æ“ä½œç çš„è¿‡ç¨‹ï¼Œæ›´é«˜çº§çš„åç¼–è¯‘åˆ™æ˜¯å†è½¬æˆä¼ªä»£ç ï¼Œæ›´åˆ©äºäººçš„é˜…è¯»ï¼Œè¿™æ¬¡æˆ‘ä»¬ç”¨ä¸ä¸Šï¼Œåç¼–è¯‘çš„æ–¹æ³•åˆ—äºæ–‡æœ«çš„é™„å½•ä¸­ã€‚\


solidityï¼ˆé«˜çº§è¯­è¨€ï¼‰->bytecode(å­—èŠ‚ç )->opcode(æ“ä½œç )

æˆ‘ä»¬å°±å¯ä»¥æ¸…æ™°çš„å‘ç°ä¸€ä¸ªç‰¹å¾ï¼Œå‡½æ•°ç­¾åéƒ½ä¼šè¢«`PUSH4` è¿™ä¸ªæ“ä½œç æ‰€æ‰§è¡Œï¼Œæ‰€ä»¥è¿›ä¸€æ­¥çš„æ–¹æ³•åˆ™æ˜¯ä»å…¨æ–‡ä¸­æå–PUSH4åçš„å†…å®¹ï¼Œä¸å‡½æ•°æ ‡å‡†åšåŒ¹é…ã€‚


![6403.jpg](https://img.learnblockchain.cn/attachments/2023/06/uJomt5Ga648714f586d67.jpg)

æˆ‘ä¹Ÿç®€å•åšäº†ä¸‹æ€§èƒ½å®éªŒï¼Œä¸å¾—ä¸è¯´Goè¯­è¨€çš„æ•ˆç‡å¾ˆå¼ºå¤§ï¼Œ1Wæ¬¡åç¼–è¯‘åªéœ€è¦220msã€‚

æ¥ä¸‹æ¥çš„å†…å®¹ä¼šæœ‰ä¸€å®šéš¾åº¦

### **3.4ã€å‡†ç¡®ç‡æå‡2-æ‰¾ä»£ç å—**

ä¸Šæ–‡ä¸­å‡†ç¡®ç‡æœ‰æ‰€æå‡ä½†è¿˜ä¸å¤Ÿï¼Œå› ä¸ºæ˜¯å…¨æ–‡æœç´¢`PUSH4`çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä»ç„¶å¯ä»¥æ„å»ºä¸€ä¸ªå˜é‡ï¼Œæ˜¯`byte4`çš„ç±»å‹ï¼Œè¿™æ ·ä¸€æ¥ä¹Ÿä¼šè§¦å‘`PUSH4`çš„æŒ‡ä»¤ã€‚

åœ¨æˆ‘è‹¦æ¼çš„æ—¶å€™ï¼Œæƒ³åˆ°ä¸€äº›å¼€æºé¡¹ç›®çš„å®ç°ï¼ŒETLæ˜¯ä¸€ä¸ªè¯»å–é“¾ä¸Šæ•°æ®åšåˆ†æçš„å·¥å…·ï¼Œå…¶ä¸­ä¼šè§£æå‡ºERC20ã€721çš„è½¬ç§»å•ç‹¬æˆè¡¨ï¼Œæ‰€ä»¥å¿…ç„¶å…·å¤‡åˆ†ç±»åˆçº¦çš„èƒ½åŠ›ã€‚


![6403.png](https://img.learnblockchain.cn/attachments/2023/06/QHxsrwMd648715022acff.png)

åˆ†æä¸‹æ¥ï¼Œå¯ä»¥å‘ç°ä»–æ˜¯åŸºäºä»£ç å—çš„åˆ†ç±»ï¼Œåªå¤„ç†ç¬¬ä¸€ä¸ª`basic_blocks[0]`é‡Œçš„`push4`æŒ‡ä»¤

**é‚£é—®é¢˜æ¥åˆ°äº†ï¼Œå¦‚ä½•å‡†ç¡®åˆ¤æ–­ä»£ç å—äº†**

ä»£ç å—çš„æ¦‚å¿µæºäº`REVERT + JUMPDEST` è¿™2ä¸ªè¿ç»­çš„æ“ä½œç ï¼Œè¿™é‡Œå¿…ç„¶éœ€è¦è¿ç»­çš„2ä¸ªï¼Œå› ä¸ºåœ¨æ•´ä¸ªå‡½æ•°é€‰å–å™¨çš„opcodeåŒºé—´é‡Œï¼Œå¦‚æœå‡½æ•°æ•°é‡è¿‡å¤šï¼Œåˆ™ä¼šå‡ºç°ç¿»é¡µçš„é€»è¾‘ï¼Œé‚£ä¹Ÿä¼šå‡ºç°`JUMPDEST` è¿™ä¸ªæŒ‡ä»¤ã€‚

![6404.png](https://img.learnblockchain.cn/attachments/2023/06/nyPmqd3w64871515c4c5b.png)

### **3.5ã€å‡†ç¡®ç‡æå‡3-æ‰¾å‡½æ•°é€‰æ‹©å™¨**

å‡½æ•°é€‰æ‹©å™¨çš„ä½œç”¨æ˜¯ï¼Œè¯»å–è¯¥ç¬”äº¤æ˜“çš„Calldataçš„å‰4ä½å­—èŠ‚ï¼Œå¹¶ä¸ä»£ç ä¸­é¢„è®¾æœ‰çš„åˆçº¦å‡½æ•°ç­¾åè¿›è¡ŒåŒ¹é…ï¼ŒååŠ©æŒ‡ä»¤è·³è½¬åˆ°å­˜å‚¨äº†è¯¥å‡½æ•°æ–¹æ³•æŒ‡å®šçš„å†…å­˜ä½ç½®

è®©æˆ‘ä»¬å°è¯•ä¸€ä¸ªæœ€å°çš„æ¨¡æ‹Ÿæ‰§è¡Œ

è¿™éƒ¨åˆ†æ˜¯ä¸¤ä¸ªå‡½æ•°çš„é€‰æ‹©å™¨store(uint 256)å’Œretrieve()``ï¼Œå¯ç®—å‡ºç­¾åæ˜¯`2e64cec1ï¼Œ6057361d`



```
60003560e01c80632e64cec11461003b5780636057361d1461005957
```

è¿›è¡Œåç¼–è¯‘åï¼Œåˆ™ä¼šå¾—åˆ°å¦‚ä¸‹çš„æ“ä½œç ä¸²ï¼Œå¯ä»¥è¯´åˆ†ä¸¤ä¸ªéƒ¨åˆ†

**ç¬¬ä¸€éƒ¨åˆ†ï¼š**

åœ¨ç¼–è¯‘å™¨ä¸­åœ¨åˆçº¦ä¸­ä»…å‡½æ•°é€‰æ‹©å™¨éƒ¨åˆ†ä¼šå»è·å–åˆ°callDataçš„å†…å®¹ï¼Œå¯“æ„æ˜¯è·å–å…¶CallDataçš„å‡½æ•°è°ƒç”¨ç­¾åï¼Œæ³¨é‡Šå¦‚ä¸‹å›¾ã€‚

![6407.png](https://img.learnblockchain.cn/attachments/2023/06/xjMKhGEq648715281501f.png)

æˆ‘ä»¬å¯ä»¥é€šè¿‡æ¨¡æ‹ŸEVMçš„å†…å­˜æ± å˜åŒ–æ¥çœ‹çœ‹æ•ˆæœ


![6405.png](https://img.learnblockchain.cn/attachments/2023/06/gCsHALNa64871535072b7.png)

**ç¬¬äºŒéƒ¨åˆ†ï¼š**

åˆ¤æ–­æ˜¯å¦ä¸é€‰æ‹©å™¨çš„å€¼åŒ¹é…çš„è¿‡ç¨‹

1ã€â€å°†retrieve()çš„4å­—èŠ‚å‡½æ•°ç­¾å(0x2e64cec1)ä¼ å…¥stackä¸Šï¼Œ

2ã€EQæ“ä½œç ä»stackåŒºå¼¹å‡º2ä¸ªå˜é‡ï¼Œå³0x2e64cec1å’Œ0x6057361dï¼Œå¹¶æ£€æŸ¥å®ƒä»¬æ˜¯å¦ç›¸ç­‰

3ã€PUSH2å°†2ä¸ªå­—èŠ‚çš„æ•°æ®(è¿™é‡Œä¸º0x003bï¼Œåè¿›åˆ¶ä¸º59)ä¼ å…¥stackï¼ŒstackåŒºæœ‰ä¸€ä¸ªå«åšç¨‹åºè®¡æ•°å™¨çš„ä¸œè¥¿ï¼Œå®ƒè§„å®šäº†ä¸‹ä¸€ä¸ªæ‰§è¡Œå‘½ä»¤åœ¨å­—èŠ‚ç ä¸­çš„ä½ç½®ã€‚è¿™é‡Œæˆ‘ä»¬è®¾ç½®59ï¼Œå› ä¸ºé‚£æ˜¯retrieve()å­—èŠ‚ç çš„èµ·å§‹ä½ç½®

4ã€JUMPIä»£è¡¨"å¦‚æœ...ï¼Œåˆ™è·³è½¬è‡³..."ï¼Œå®ƒä»stackä¸­å¼¹å‡º2ä¸ªå€¼ä½œä¸ºè¾“å…¥ï¼Œå¦‚æœæ¡ä»¶ä¸ºçœŸï¼Œç¨‹åºè®¡æ•°å™¨å°†è¢«æ›´æ–°è‡³59ã€‚

è¿™å°±æ˜¯EVMæ˜¯å¦‚ä½•æ ¹æ®åˆçº¦ä¸­çš„å‡½æ•°è°ƒç”¨ï¼Œæ¥ç¡®å®šå®ƒéœ€è¦æ‰§è¡Œçš„å‡½æ•°å­—èŠ‚ç çš„ä½ç½®çš„åŸç†ã€‚

å®é™…ä¸Šï¼Œè¿™åªæ˜¯ä¸€ç»„ç®€å•çš„â€œifè¯­å¥â€ï¼Œç”¨äºåˆçº¦ä¸­çš„æ¯ä¸ªå‡½æ•°ä»¥åŠå®ƒä»¬çš„è·³è½¬ä½ç½®ã€‚


![6406.png](https://img.learnblockchain.cn/attachments/2023/06/g2Tz9ALm648715435ad84.png)

## **4ã€æ–¹æ¡ˆæ€»ç»“**

æ•´ä½“ç®€è¿°å¦‚ä¸‹

1. æ¯ä¸ªåˆçº¦åœ°å€å¯ä»¥é€šè¿‡rpcÂ getcode æˆ–è€…debug_traceTransactionï¼Œè·å–åˆ°éƒ¨ç½²åçš„bytecode ï¼Œé‡‡ç”¨GOä¸­VMå’ŒASMåº“ï¼Œåç¼–è¯‘åå³è·å–åˆ°opcode
2. åˆçº¦åœ¨`EVM`è¿è¡ŒåŸç†ä¸­ï¼Œä¼šæœ‰ä»¥ä¸‹ç‰¹å¾
3. 1. é‡‡ç”¨REVERT+JUMPDESTè¿™2ä¸ªè¿ç»­çš„ `opcode` ä½œä¸ºä»£ç å—çš„åŒºåˆ†
   2. åˆçº¦å¿…ç„¶å…·å¤‡å‡½æ•°é€‰æ‹©å™¨çš„åŠŸèƒ½ï¼Œè¯¥åŠŸèƒ½ä¹Ÿå¿…ç„¶åœ¨ç¬¬ä¸€ä¸ªä»£ç å—ä¸Š
   3. å‡½æ•°é€‰æ‹©å™¨ä¸­ï¼Œå…¶å‡½æ•°æ–¹æ³•å‡é‡‡ç”¨PUSH4ä½œä¸º`opcode` ï¼Œ
   4. è¯¥é€‰æ‹©å™¨æ‰€åŒ…å«çš„opcodeä¸­ï¼Œä¼šå‡ºç°è¿ç»­çš„PUSH1 00; CALLDATALOAD; PUSH1 e0; SHR; DUP1ï¼Œæ ¸å¿ƒåŠŸèƒ½æ˜¯åŠ è½½callDateæ•°æ®å¹¶è¿›è¡Œä½ç§»æ“ä½œï¼Œä»åˆçº¦åŠŸèƒ½ä¸Šå…¶ä»–è¯­æ³•ä¸ä¼šäº§ç”Ÿ
4. å¯¹åº”çš„å‡½æ•°ç­¾ååœ¨`eip`ä¸­å®šä¹‰ï¼Œå¹¶ä¸”æœ‰å¿…é€‰å’Œå¯é€‰çš„æ˜ç¡®è¯´æ˜

### **4.1ã€å”¯ä¸€æ€§è¯æ˜**

èµ°åˆ°è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥è¯´ï¼ŒåŸºæœ¬å®ç°é«˜æ•ˆç‡ï¼Œé«˜å‡†ç¡®ç‡çš„åˆçº¦åˆ†ææ–¹æ³•äº†ï¼Œå½“ç„¶æ—¢ç„¶å·²ç»ä¸¥è°¨äº†è¿™ä¹ˆä¹…ï¼Œä¸å¦¨å†ä¸¥è°¨ä¸€äº›ï¼Œæˆ‘ä»¬ä¸Šæ–‡æ–¹æ¡ˆé‡Œä¸­åŸºäºREVER+JUMPDESTæ¥åšä»£ç å—çš„åŒºåˆ†ï¼Œç»“åˆå…¶ä¸­å¿…ç„¶çš„CallDateåŠ è½½å’Œä½ç§»æ¥åšå”¯ä¸€æ€§åˆ¤æ–­ï¼Œé‚£æ˜¯å¦å­˜åœ¨ï¼Œæˆ‘å¯ä»¥ç”¨solidityåˆçº¦ä¹Ÿå®ç°å‡ºç±»ä¼¼çš„æ“ä½œç åºåˆ—å‘¢ï¼Ÿ

æˆ‘åšäº†ä¸‹å¯¹ç…§å®éªŒï¼Œä»`solidity`è¯­æ³•å±‚é¢è™½ç„¶äº¦æœ‰`msg.sig`ç­‰è·å–`CallData`çš„æ–¹æ³•ï¼Œä½†ç¼–è¯‘åå…¶`opcode`çš„å®ç°æ–¹æ³•ä¸åŒ


![6408.png](https://img.learnblockchain.cn/attachments/2023/06/HlOvKAeX6487154cccb46.png)

## **5ã€æ€»ç»“**

æ´‹æ´‹æ´’æ´’è¿™ä¹ˆåˆ†æä¸‹æ¥ï¼Œ3å¤©æ—¶é—´å°±è¿‡å»äº†ã€‚

è™½ç„¶éå¸¸çš„ç»†è‡´ï¼Œè™½ç„¶æ—¥å¸¸ä¸­ä¼šé‡åˆ°åˆçº¦é‡‡ç”¨`byte4`æ¥æ¶æ„æ··æ·†è‡ªå·±æ˜¯å¦ç¬¦åˆæ ‡å‡†çš„åˆçº¦å¯èƒ½æ˜¯ä¹ç‰›ä¸€æ¯›ã€‚

æ‰€ä»¥ï¼Œå®é™…ä¸Šè¿™3å¤©æŠ•å…¥åˆ†æçš„ROIæ˜¯éå¸¸ä½çš„ã€‚ä½†æ˜¯åœ¨æ— å°½çš„æ—¶é—´é•¿æ²³é‡Œï¼Œæ¦‚ç‡å†å°çš„äº‹æƒ…ï¼Œä¹Ÿç»ˆå°†å‘ç”Ÿã€‚

æ€€æ£ä¸ä¿¡ä»»åŸåˆ™æ‰èƒ½åœ¨web3çš„ä¸–ç•Œé‡Œï¼Œèµ°çš„æ›´è¿œã€‚



ä»Šå¤©æœ‰å¥½å‹é—®æˆ‘ä¸€ä¸ªå¾ˆæœ‰æ€è€ƒæ·±åº¦çš„è¯é¢˜ï¼Œä½œä¸ºäº§ä¸šKOLçš„ç»ˆå±€æ˜¯ä»€ä¹ˆï¼Ÿä½ çš„å•†ä¸šæ¨¡å¼æ˜¯ä»€ä¹ˆï¼Ÿ

è™½ç„¶æˆ‘çŸ¥é“æŠ€æœ¯çš„æ–‡ç« ï¼Œæ€»æ˜¯æµé‡æƒ¨æ·¡ï¼Œä½†æµé‡æœ¬å°±ä¸æ˜¯ç›®çš„ï¼Œæˆ‘å¸Œæœ›å§‹ç»ˆéƒ½åœ¨æœ€åˆçš„æ„¿æ™¯ä¸Šï¼š

Â ğŸ’¡ ä»¥æŠ€æœ¯çš„è§†è§’ï¼Œæ´å¯Ÿäº§ä¸šå‘å±•çš„å…³é”®å˜åŒ–ï¼Œåˆ†äº«äº§ä¸šå‘å±•ä¸­çš„è¿‡å¾€ç»éªŒä¸æœªæ¥æœºä¼šï¼Œä¸ºæ–°æ—¶ä»£çš„å»ºè®¾è€…æä¾›å·®å¼‚åŒ–çš„å¸®åŠ©ã€‚




## é™„å½•

> *å¦‚éœ€opcodeæ ·ä¾‹ä»¥åŠGoè¿›è¡Œåç¼–è¯‘çš„æ ·ä¾‹ä»£ç ï¼Œå¯å…¬ä¼—å·åå°å›å¤â€åˆçº¦åˆ†ç±»â€è·å–ã€‚*
> 
> *ä¾èµ–åº“ï¼š*
> 
> *https\://pkg.go.dev/github.com/ethereum/go-ethereum\@v1.11.6/core/asm#Compiler.Feed*
> 
> *https\://pkg.go.dev/github.com/ethereum/go-ethereum\@v1.11.6/core/vm*
> 
> *åŸç†è§£æ:*
> 
> *https\://whileydave.com/2023/01/04/disassembling-evm-bytecode-the-basics/*
> 
> *https\://yanniss.github.io/elipmoc-oopsla22.pdf*
> 
> *https\://yanniss.github.**io/gigahorse-icse19.pdf*
> 
> *https\://www\.evm.codes/?fork=shanghai*
> 
> *https\://learnblockchain.cn/article/4800*
> 
> *https\://learnblockchain.cn/article/3647*
> 
> *å¼€æºé¡¹ç›®æºç å‚è€ƒ:*
> 
> *https\://github.com/blockchain-etl/ethereum-etl/blob/2da9d050f4ae4fa4e818bbfb22d5cfb5234b2e29/ethereumetl/service/eth_contract_service.py#L29-L43*
> 
> *https\://github.com/ethereum/evmdasm**https\://github.com/tintinweb/ethereum-dasm/blob/master/ethereum_dasm/evmdasm.py#L342*






### **ã€åå››å›-åŸåˆ›å›é¡¾ã€‘**

* [ç”¨ä¸€ä¸ªå°æ—¶è®²æ¸…æ¥šè´¦å·æŠ½è±¡è¿™ä»¶äº‹](http://mp.weixin.qq.com/s?\__biz=MzIyMTQ5MTg5Mw==\&mid=2247484171\&idx=1\&sn=3b5635fa84742e21cd6ca47e60ec1d6b\&chksm=e83aa4d1df4d2dc73a690e49477f27726f81335995b7bb9343d412211223b278ce2f67466276\&scene=21#wechat_redirect)\

* [è§£è¯»æ¯”ç‰¹å¸Oridinalsåè®®ä¸BRC20æ ‡å‡† åŸç†åˆ›æ–°ä¸å±€é™](http://mp.weixin.qq.com/s?\__biz=MzIyMTQ5MTg5Mw==\&mid=2247484156\&idx=1\&sn=cefc374edbe3478817fe2e864ed85649\&chksm=e83aa526df4d2c30addb352b2fd9cf1af4c24a6a1e25c04bf0c8790702a664ab1c0370bf0037\&scene=21#wechat_redirect)
* [è·¨é“¾èµ›é“ç ”æŠ¥ï¼šLayerZeroå…¨é“¾äº’æ“ä½œåè®®å‡­ä»€ä¹ˆä¼°å€¼30äº¿ç¾é‡‘(ä¸Šï¼‰](http://mp.weixin.qq.com/s?\__biz=MzIyMTQ5MTg5Mw==\&mid=2247484151\&idx=1\&sn=345fb4a3ae6efbe52606fe2af4b85a3e\&chksm=e83aa52ddf4d2c3bd84d1ddfefdfc3a1a06a8274dbd28f43cea205202364acd2a15e63231edc\&scene=21#wechat_redirect)
* [ä½“éªŒWeb3.Unityå¹¶å›é¡¾GameFiæ¢ç´¢ä¹‹è·¯](http://mp.weixin.qq.com/s?\__biz=MzIyMTQ5MTg5Mw==\&mid=2247484142\&idx=1\&sn=d0edb41636937f32753a61f7e7d6515d\&chksm=e83aa534df4d2c228852e2d2945478bb85561d35bdb0bd886cea9a36c0f540405ad824474f8a\&scene=21#wechat_redirect)
* [ä»¥å¤ªåŠè´¦å·æŠ½è±¡ERC4337çš„è¿‡å®¡æ–¹æ¡ˆè§£è¯»(ä¸Šï¼‰](http://mp.weixin.qq.com/s?\__biz=MzIyMTQ5MTg5Mw==\&mid=2247484135\&idx=1\&sn=b6c098f0e3218f61459604ecf9b17ec3\&chksm=e83aa53ddf4d2c2b41c9cdba36c4341b29db78951c35760dfa3e42652152a1cf62bfc6769a6f\&scene=21#wechat_redirect)\

* [è§£è¯»æœ€æ–°Finalçš„ERC-6147ï¼šæç®€çš„åŠå¼ºåˆ¶æ€§NFTäº§æƒåˆ†ç¦»æ ‡å‡†](http://mp.weixin.qq.com/s?\__biz=MzIyMTQ5MTg5Mw==\&mid=2247484127\&idx=1\&sn=4b930ce55709c5c18f9b308e5115f6e0\&chksm=e83aa505df4d2c13a450bd34728e2ed24ed17946e9fca4cddc74e3b3193a829ed2a4d6572a8d\&scene=21#wechat_redirect)
* [ä»ä»½è´¦å•è¯´èµ·ï¼Œä¸ºä»€ä¹ˆé“¾ä¸Šäº¤æ˜“å€¼å¾—åˆ†æï¼Ÿ](http://mp.weixin.qq.com/s?\__biz=MzIyMTQ5MTg5Mw==\&mid=2247484114\&idx=1\&sn=915f9e4bdddb3be5c3bedc5631513813\&chksm=e83aa508df4d2c1e57645b4d4bbfed8b1d43948bb751c962f59bd4dd8d964614b478c9b45eae\&scene=21#wechat_redirect)\

* [è§£è¯»Nostrï¼šæŠ—å®¡æŸ¥çš„å»ä¸­å¿ƒåŒ–ç¤¾äº¤åè®®](http://mp.weixin.qq.com/s?\__biz=MzIyMTQ5MTg5Mw==\&mid=2247484105\&idx=1\&sn=bd4c2264062770836321ef2b8faad151\&chksm=e83aa513df4d2c05d6b768d3d4498645eca1768c29f0e478dfe6e89acff8beb35e75563d24a2\&scene=21#wechat_redirect)\



æ¬¢è¿ä½ ä»å…¬ä¼—å·åå°ç•™è¨€ä½œè€…ï¼Œæ¢è®¨web3è¡Œä¸šé—®é¢˜

ç‚¹èµå…³æ³¨åå››ï¼Œç”¨æŠ€æœ¯è§†è§’å¸¦ç»™ä½ ä»·å€¼

<!--EndFragment-->
